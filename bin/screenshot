#!/usr/bin/env ruby
# *************************************
#
#   Screenshot
#   -> Capture website images
#
# *************************************

# -------------------------------------
#   Dependencies
# -------------------------------------

require 'json'
require 'net/http'
require 'slugify'

# -------------------------------------
#   Config
# -------------------------------------

data = 'https://api.airtable.com/v0/apptKHbxmAAcPuZMW/specimens?api_key=key3GGb7zxleGAfHl&sortField=Title'

# -------------------------------------
#   Main
# -------------------------------------

# ----- JSON ----- #

response = Net::HTTP.get(URI(data))
sites    = JSON.parse(response)['records']

# ----- Do the Thing ----- #

for site in sites do
  slug = site['fields']['Title'].slugify
  url  = site['fields']['URL']

  if site['fields']['Queue Screenshot']
    if site['fields']['Screenshot Delay']
      system "webkit2png --width=1200 --height=900 --fullsize --delay=10 --ignore-ssl-check --dir=screenshots --filename #{slug} #{url}"
    else
      system "webkit2png --width=1200 --height=900 --fullsize --ignore-ssl-check --dir=screenshots --filename #{slug} #{url}"
    end

    system "mv screenshots/#{slug}-full.png screenshots/#{slug}.png"
    system "convert screenshots/#{slug}.png -crop 2400x1800+0+0 screenshots/#{slug}-cropped.png"
    system "convert -resize 600 screenshots/#{slug}-cropped.png TGA:- | cjpeg -quality 60 -outfile screenshots/#{slug}-thumb.jpg -targa -optimize"
    system "/Applications/ImageOptim.app/Contents/MacOS/ImageOptim screenshots/#{slug}-thumb.jpg"
  end
end
